



优化基于21.7.3

# Explain查看执行计划

在20.6之前的版本需要设置日志级别为trace才能查看，也只是真正执行sql，才能在日志里查看。

在20.6.3称为正式版之后，成为正式功能

主要语法是explain ，plan是默认的，其中还有

​	ast语法树

​	pipeline查看pipeline计划

​	header查看header信息

老版本查看，命令行指令

```shell
clickhouse-client -h 主机 --send_logs_level=trace <<< "sql" > /dev/null
```

/dev/null是为了把查询结果放入空设备丢弃

debug和trace级别都可以实现查看执行计划

# 三方面的优化

## 	建表优化

数据类型

时间字段

​	时间字段不需要指定为字符串类型，字符串类型主要是在hive架构里常见，在ck中不一定非要string，直接使用dateTime效率高

空值存储

​	官方指出nullable类型会拖累性能，所以除非特殊情况，对可能产生null值的字段根据业务设置对应的值会提升效率

分区和索引

​	分区一般要考虑适当的粒度，一般按天分区，如果不按照天分区，参考1亿条数据的表一般分30个 左右的区

索引通过order by指定，可以多个字段，查询频率高的在前，基数太大的不建议做索引

表参数

索引粒度默认是8192，如果表中数据不是一定要全量保留的话可以设置生存时间值缩写是TTL，这样可以避免手动过滤历史数据，ttl可以随时通过alter table操作来改变

写入和删除

不建议进行小数据量的写入和删除，这样会产生大量的小分区临时文件，这样会增加merge操作的压力



不建议写入速度太快，这样merge的速度会跟不上，建议每秒2到3次写入，每次5万左右的数据量

常见配置



















## 	语法优化规则

## 	查询优化

# 数据一致性

# 物化视图

# MaterializeMySQL引擎

# 常见问题排查

